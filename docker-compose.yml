version: '3.8'

services:
  # Payments Service
  payments_service:
    build: ./payments-service
    container_name: payments_service
    ports:
      - "8003:3000"
    environment:
      # Service Configuration
      - NODE_ENV=production
      - PORT=3000
      
      # Database Configuration
      - DATABASE_HOST=payments_db
      - DATABASE_PORT=5432
      - DATABASE_NAME=payments_db
      - DATABASE_USER=payments_user
      - DATABASE_PASSWORD=payments_password
      - DATABASE_URL=postgresql://payments_user:payments_password@payments_db:5432/payments_db
      
      # JWT Configuration (Must match auth service)
      - SECRET_KEY=XXeuvJaUcF9EEQT0s0IwY241CwWgzv260tmjhox2AMk=
      - JWT_ALGORITHM=HS256
      
      # External Services
      - ORDERS_SERVICE_URL=http://orders-service:8080
      - AUTH_SERVICE_URL=http://auth_service:8001
      
      # Service Timeouts
      - ORDERS_SERVICE_TIMEOUT=10000
      - AUTH_SERVICE_TIMEOUT=10000
      
      # Payment Configuration
      - PAYMENT_APPROVAL_RATE=90
      - PAYMENT_PROCESSING_DELAY=2000
    depends_on:
      payments_db:
        condition: service_healthy
      auth_service:
        condition: service_started
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Payments Database
  payments_db:
    image: postgres:15-alpine
    container_name: payments_db
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: payments_user
      POSTGRES_PASSWORD: payments_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      - "5435:5432"
    volumes:
      - payments_postgres_data:/var/lib/postgresql/data
      - ./payments-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payments_user -d payments_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Auth Service (Python FastAPI)
  auth_service:
    build: ./auth_service
    container_name: auth_service
    ports:
      - "8001:8001"
    env_file:
      - ./auth_service/.env
    depends_on:
      - auth_db
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Database
  auth_db:
    image: postgres:15-alpine
    container_name: auth_db
    environment:
      POSTGRES_USER: authuser
      POSTGRES_PASSWORD: authpassword
      POSTGRES_DB: amor
    ports:
      - "5437:5432"
    volumes:
      - auth_postgres_data:/var/lib/postgresql/data
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U authuser -d amor"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Orders Service (Java Spring Boot)
  orders_service:
    build: ./demo/orders-service
    container_name: orders-service
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=orders_db
      - DB_PORT=5432
      - DB_NAME=orders_db
      - DB_USER=orders_user
      - DB_PASSWORD=orders_password
      - AUTH_SERVICE_URL=http://auth_service:8001
    depends_on:
      orders_db:
        condition: service_healthy
      auth_service:
        condition: service_started
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/orders/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Orders Database
  orders_db:
    image: postgres:15-alpine
    container_name: orders_db
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: orders_user
      POSTGRES_PASSWORD: orders_password
    ports:
      - "5436:5432"
    volumes:
      - orders_postgres_data:/var/lib/postgresql/data
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orders_user -d orders_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Products Service (Laravel/PHP)
  product_service:
    build: ./product-service
    container_name: product-service
    ports:
      - "8000:8000"
    env_file:
      - ./product-service/.env
    depends_on:
      - product_db
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Products Database
  product_db:
    image: postgres:15-alpine
    container_name: product_db
    environment:
      POSTGRES_DB: laravel
      POSTGRES_USER: sail
      POSTGRES_PASSWORD: password
    ports:
      - "5438:5432"
    volumes:
      - product_postgres_data:/var/lib/postgresql/data
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sail -d laravel"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Inventory Service (Rust)
  inventory_service:
    build: ./InventoryService
    container_name: inventory_service
    ports:
      - "8002:3000"
    environment:
      - DATABASE_URL=postgres://user:password@inventory_db:5432/storedb
      - RUST_LOG=debug
    depends_on:
      inventory_db:
        condition: service_healthy
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Notifications Service (Go)
  notifications_service:
    build: ./notifications-service
    container_name: notifications_service
    ports:
      - "8082:8082"
    environment:
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      - EMAIL_FROM=angel2296rojas@gmail.com
      - EMAIL_PASSWORD=tmwq uabq htxb tgzr
      - PORT=8082
      - HOST=0.0.0.0
      - LOG_LEVEL=info
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/api/v1/notify"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Inventory Database
  inventory_db:
    image: postgres:16
    container_name: inventory_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: storedb
    ports:
      - "5434:5432"
    volumes:
      - inventory_postgres_data:/var/lib/postgresql/data
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d storedb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Frontend (Vue.js)
  frontend:
    build: ./frontend
    container_name: microservices-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8080/api
      - VITE_AUTH_BASE_URL=http://localhost:8001
    depends_on:
      auth_service:
        condition: service_started
      orders_service:
        condition: service_started
      product_service:
        condition: service_started
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy (Optional)
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - auth_service
      - orders_service
      - product_service
      - payments_service
      - inventory_service
      - notifications_service
    networks:
      - microservices_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  payments_postgres_data:
  auth_postgres_data:
  orders_postgres_data:
  product_postgres_data:
  inventory_postgres_data:

networks:
  microservices_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16